document.addEventListener("DOMContentLoaded",function(){let e=document.getElementById("searchForm"),t=document.getElementById("searchInput"),s=document.getElementById("searchResults"),a=document.getElementById("loading"),i=document.getElementById("backToTop"),l=new bootstrap.Modal(document.getElementById("movieDetailsModal"),{backdrop:!0,keyboard:!0}),n=document.getElementById("movieDetailsContent"),r=document.getElementById("mainHeader"),o=0,d=null,c=1,p="",u=0,m=0,g=!1;async function v(e,t=1){if(!g){g=!0,p=e,c=t,s.style.display="none",a.style.display="block";try{let i=await fetch(`api.php?action=search&q=${encodeURIComponent(e)}&page=${t}`,{method:"GET",headers:{Accept:"application/json"}}),l=i.headers.get("content-type");if(!l||!l.includes("application/json"))throw Error("R\xe9ponse non-JSON re\xe7ue du serveur");if(!i.ok)throw Error(`Erreur HTTP: ${i.status}`);let n=await i.json();n.success?(u=n.total_results,m=Math.min(Math.ceil(u/20),500),function e(t){let a=(c-1)*20+1,i=Math.min(20*c,u),l=`
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h2 class="h4 mb-0">R\xe9sultats pour "${t.query}"</h2>
                <small class="text-muted">${u.toLocaleString()} r\xe9sultat(s)</small>
            </div>
        `;u>20&&(l+=`
                <div class="pagination-info">
                    Affichage des r\xe9sultats <span class="current-range">${a.toLocaleString()} \xe0 ${i.toLocaleString()}</span> 
                    sur <span class="total-count">${u.toLocaleString()}</span>
                </div>
            `),l+='<div class="row g-4 mb-4">',0===t.results.length?l+=`
                <div class="col-12 text-center py-4">
                    <img src="https://placehold.co/300x200/a7e3d0/0a5045?text=Aucun+r\xe9sultat" alt="Aucun r\xe9sultat" class="img-fluid mb-3" style="max-width: 300px; border-radius: 1rem;">
                    <p class="text-muted">Aucun film trouv\xe9 pour cette recherche</p>
                    <p class="small text-muted">Essayez avec des mots-cl\xe9s diff\xe9rents</p>
                </div>
            `:t.results.forEach(e=>{var t,s=80;l+=`
                    <div class="col-12 col-sm-6 col-md-3 col-lg-3">
                        <div class="card h-100 shadow-sm movie-card">
                            <div class="poster-container">
                                <img src="${e.poster}" 
                                     alt="Affiche de ${e.title}" 
                                     class="card-img-top"
                                     loading="lazy"
                                     onerror="this.src='https://placehold.co/300x450/a7e3d0/0a5045?text=Image+indisponible'">
                            </div>
                            <div class="card-body">
                                <h3 class="card-title h5 movie-title">${e.title}</h3>
                                <div class="mb-2">
                                    <span class="badge bg-secondary badge-year">${e.year}</span>
                                    ${e.rating>0?`<span class="badge bg-info text-dark ms-1">${e.rating}/10</span>`:""}
                                </div>
                                <div class="small text-muted mb-2">${e.genres}</div>
                                <p class="card-text small">${t=e.overview,!t||t.length<=s?t:t.substring(0,s).trim()+"..."}</p>
                            </div>
                            <div class="card-footer bg-white">
                                <button class="btn btn-sm btn-outline-primary w-100 view-details" data-movie-id="${e.id}">
                                    <span class="me-1">üëÅÔ∏è</span>D\xe9tails
                                </button>
                            </div>
                        </div>
                    </div>
                `}),l+="</div>",m>1&&(l+=function e(){if(m<=1)return"";let t='<div class="custom-pagination">';c>1?t+=`
                <a href="#" class="custom-page-item custom-page-nav prev-indicator" data-page="${c-1}" aria-label="Page pr\xe9c\xe9dente">
                    ‚Äπ Pr\xe9c\xe9dent
                </a>
            `:t+=`
                <span class="custom-page-item custom-page-nav disabled" aria-label="Page pr\xe9c\xe9dente">
                    ‚Äπ Pr\xe9c\xe9dent
                </span>
            `;let s=[],a=[];s.push(1);for(let i=Math.max(2,c-2);i<=Math.min(m-1,c+2);i++)s.push(i);m>1&&s.push(m);let l;for(let n of s)l&&(n-l==2?a.push(l+1):n-l!=1&&a.push("...")),a.push(n),l=n;return a.forEach(e=>{if("..."===e)t+=`<span class="custom-page-ellipsis">‚ãØ</span>`;else if(e===c)t+=`
                    <span class="custom-page-item active" aria-current="page">
                        ${e}
                    </span>
                `;else{let s=Math.abs(e-c)>1&&1!==e&&e!==m;t+=`
                    <a href="#" class="custom-page-item ${s?"hide-mobile":""}" data-page="${e}">
                        ${e}
                    </a>
                `}}),c<m?t+=`
                <a href="#" class="custom-page-item custom-page-nav next-indicator" data-page="${c+1}" aria-label="Page suivante">
                    Suivant ‚Ä∫
                </a>
            `:t+=`
                <span class="custom-page-item custom-page-nav disabled" aria-label="Page suivante">
                    Suivant ‚Ä∫
                </span>
            `,t+="</div>"}()),s.innerHTML=l,document.querySelectorAll(".view-details").forEach(e=>{e.addEventListener("click",function(){let e=this.getAttribute("data-movie-id");$(e)})}),document.querySelectorAll(".custom-page-item[data-page]").forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();let t=parseInt(this.getAttribute("data-page"));if(p&&!g&&t!==c&&t>=1&&t<=m){document.querySelector(".custom-pagination").classList.add("pagination-loading"),v(p,t);let s=document.getElementById("searchResults").offsetTop-100;window.scrollTo({top:s,behavior:"smooth"})}})})}(n)):h(n.error||"Erreur lors de la recherche")}catch(r){console.error("Erreur lors de la recherche:",r),h("Erreur de connexion. V\xe9rifiez la configuration de l'API.")}finally{g=!1,a.style.display="none",s.style.display="block"}}}function h(e){s.innerHTML=`
            <div class="text-center py-4">
                <div class="alert alert-warning" role="alert">
                    <strong>Oups !</strong> ${e}
                </div>
                <img src="https://placehold.co/300x200/a7e3d0/0a5045?text=Erreur" alt="Erreur" class="img-fluid mb-3" style="max-width: 300px; border-radius: 1rem;">
            </div>
        `}async function $(e){n.innerHTML=`
            <div class="text-center py-4">
                <div class="spinner-border loading-spinner" role="status">
                    <span class="visually-hidden">Chargement...</span>
                </div>
                <p class="mt-2">Chargement des d\xe9tails...</p>
            </div>
        `,l.show();try{let t=await fetch(`api.php?action=movie&id=${e}`,{method:"GET",headers:{Accept:"application/json"}});if(!t.ok)throw Error(`Erreur HTTP: ${t.status}`);let s=await t.json();if(s.success)!function e(t){let s=`
            <div class="row">
                <div class="col-md-4 mb-4 mb-md-0 text-center">
                    <img src="${t.poster}" 
                         alt="Affiche de ${t.title}" 
                         class="img-fluid rounded modal-poster"
                         onerror="this.src='https://placehold.co/300x450/a7e3d0/0a5045?text=Image+indisponible'">
                </div>
                <div class="col-md-8">
                    <h2 class="mb-2">${t.title}</h2>
                    ${t.original_title!==t.title?`<p class="text-muted mb-2"><em>${t.original_title}</em></p>`:""}
                    
                    <div class="mb-3">
                        <span class="badge bg-secondary me-2">${t.year}</span>
                        ${t.rating>0?`<span class="badge bg-info text-dark me-2">${t.rating}/10</span>`:""}
                        ${"Non sp\xe9cifi\xe9"!==t.runtime?`<span class="text-muted">${t.runtime}</span>`:""}
                    </div>

                    <div class="mb-3">
                        <small class="text-muted">Sorti le ${t.release_date}</small>
                    </div>

                    <h3 class="h5 mt-3">Synopsis</h3>
                    <p>${t.overview||"Synopsis non disponible."}</p>

                    <h3 class="h5 mt-3">Informations</h3>
                    <ul class="list-unstyled">
                        <li><strong>Genres :</strong> ${t.genres}</li>
                        <li><strong>R\xe9alisateur :</strong> ${t.director}</li>
                        <li><strong>Acteurs principaux :</strong> ${t.cast}</li>
                        ${t.vote_count?`<li><strong>Nombre de votes :</strong> ${t.vote_count}</li>`:""}
                    </ul>
                </div>
            </div>
        `;n.innerHTML=s}(s.movie);else throw Error(s.error||"Erreur lors du chargement")}catch(a){console.error("Erreur lors du chargement des d\xe9tails:",a),n.innerHTML=`
                <div class="text-center py-4">
                    <div class="alert alert-danger" role="alert">
                        <strong>Erreur</strong><br>
                        Impossible de charger les d\xe9tails du film.
                    </div>
                </div>
            `}}window.addEventListener("scroll",function(){let e=window.pageYOffset||document.documentElement.scrollTop;e>10?r.classList.add("header-scrolled"):r.classList.remove("header-scrolled"),e>o&&e>100?r.classList.add("header-hidden"):e<o-5&&r.classList.remove("header-hidden"),o=e<=0?0:e,e>300?i.style.display="block":i.style.display="none"}),e.addEventListener("submit",function(e){e.preventDefault();let s=t.value.trim();""===s||g||v(s,1)}),t.addEventListener("input",function(){clearTimeout(d);let e=this.value.trim();e.length>=2&&(d=setTimeout(()=>{g||v(e,1)},500))}),i.addEventListener("click",function(){window.scrollTo({top:0,behavior:"smooth"})}),document.getElementById("movieDetailsModal").addEventListener("hidden.bs.modal",function(){n.innerHTML=`
            <div class="text-center py-4">
                <div class="spinner-border loading-spinner" role="status">
                    <span class="visually-hidden">Chargement...</span>
                </div>
                <p class="mt-2">Chargement des d\xe9tails...</p>
            </div>
        `});let f=setInterval(()=>{d&&(clearTimeout(d),d=null);let e=document.querySelector(".custom-pagination");e&&e.classList.remove("pagination-loading")},3e5);window.addEventListener("beforeunload",function(){clearInterval(f),d&&clearTimeout(d)})});